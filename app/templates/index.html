{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <div class="card shadow-soft rounded-4">
            <div class="card-header text-center bg-pink rounded-top">
                <h2>Medication Side Effect Prediction</h2>
            </div>
            <div class="card-body">
                <form id="predictionForm" action="/predict" method="post" novalidate>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label for="age" class="form-label">üéÇ Age</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="age" name="age" required min="0" max="120" />
                                <span class="input-group-text">years</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="weight" class="form-label">‚öñÔ∏è Weight</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="weight" name="weight" required min="0" max="300" />
                                <span class="input-group-text">kg</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="height" class="form-label">üìè Height</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="height" name="height" required min="0" max="250" />
                                <span class="input-group-text">cm</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="sex" class="form-label">üë• Gender</label>
                            <select class="form-select" id="sex" name="sex" required>
                            <option value="" disabled selected>Select Gender</option>
                            <option value="1">üë®üèº Male</option>
                            <option value="2">üë©üèº Female</option>
                            </select>
                        </div>

                    <div class="mb-3">
                        <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="serious" name="serious">
                                <label class="form-check-label" for="serious">
                                üå∏ Serious Condition
                                </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="medicalHistory" class="form-label">üìã Medical History</label>
                        <select multiple class="form-select" id="medicalHistory" name="medical_history">
                            <option value="Hypertension">Hypertension</option>
                            <option value="Diabetes">Diabetes</option>
                            <option value="HeartDisease">Heart Disease</option>
                            <option value="Asthma">Asthma</option>
                            <option value="Cancer">Cancer</option>
                        </select>
                        <small class="text-muted">Hold Ctrl/Cmd to select multiple conditions</small>
                    </div>

                    <div class="mb-4">
                        <label for="medications" class="form-label">üíä Medications</label>
                        <select multiple class="form-select" id="medications" name="medications">
                            <option value="aspirin">Aspirin</option>
                            <option value="ibuprofen">Ibuprofen</option>
                            <option value="amoxicillin">Amoxicillin</option>
                            <option value="metformin">Metformin</option>
                            <option value="lisinopril">Lisinopril</option>
                            <option value="atorvastatin">Atorvastatin</option>
                            <option value="fluoxetine">Fluoxetine</option>
                            <option value="omeprazole">Omeprazole</option>
                        </select>
                        <small class="text-muted">Hold Ctrl/Cmd to select multiple medications</small>
                    </div>

                    <!-- Laboratuvar Testleri -->
                    <div id="labTests" class="mb-3">
                        <label class="form-label">üî¨ Laboratory Tests</label>
                        <div class="lab-test-container">
                            <div class="row mb-2 lab-test-row">
                                <div class="col-md-3">
                                    <select class="form-select test-name" name="test-name" title="Test Name" aria-label="Test Name">
                                        <option value="">Select test</option>
                                        <option value="BloodPressure">Blood Pressure</option>
                                        <option value="BloodSugar">Blood Sugar</option>
                                        <option value="Cholesterol">Cholesterol</option>
                                        <option value="Hemoglobin">Hemoglobin</option>
                                        <option value="WhiteBloodCell">White Blood Cell Count</option>
                                        <option value="Platelets">Platelets</option>
                                        <option value="Creatinine">Creatinine</option>
                                        <option value="ALT">ALT (Liver Function)</option>
                                        <option value="AST">AST (Liver Function)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control test-result" name="test-result" placeholder="Result" aria-label="Test Result">
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control test-unit" name="test-unit" placeholder="Unit" aria-label="Test Unit">
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-danger remove-test">Remove</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" id="addLabTest">Add Lab Test</button>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-pink px-5">
                            üåº Predict Side Effects
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="alert alert-danger mt-4" style="display: none;">
            <h4 class="alert-heading">Error!</h4>
            <p id="errorText"></p>
            <button class="btn btn-sm btn-danger" onclick="copyError()">Copy Error Message</button>
        </div>

        <!-- Prediction Results -->
        <div id="results" class="mt-4" style="display: none;">
            <div class="card shadow-soft rounded-4">
                <div class="card-header text-center bg-pink rounded-top">
                    <h3>Prediction Results</h3>
                </div>
                <div class="card-body" id="resultsContent">
                </div>
            </div>
        </div>

        <!-- Veri G√∂rselle≈ütirme Kartƒ± -->
        <div id="visualizations" class="mt-4" style="display: none;">
            <div class="card shadow-soft rounded-4">
                <div class="card-header text-center bg-pink rounded-top">
                    <h3>Risk Visualizations</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container" style="position: relative; height:250px;">
                                <canvas id="riskGauge"></canvas>
                            </div>
                            <h5 class="text-center mt-2">Overall Risk Level</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container" style="position: relative; height:250px;">
                                <canvas id="medicationRisksChart"></canvas>
                            </div>
                            <h5 class="text-center mt-2">Medication Risk Comparison</h5>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="chart-container" style="position: relative; height:300px; width:100%">
                                <canvas id="sideEffectsChart"></canvas>
                            </div>
                            <h5 class="text-center mt-2">Potential Side Effects by Probability</h5>
                            <div class="text-muted small text-center">
                                <p>Data sourced from OpenFDA and medical research. Colors indicate severity level (red: high, orange: medium, green: low).<br>
                                Click on any bar for detailed information about the side effect.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- G√∂rsel Yan Etki Raporu -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-pink">
                                    <h5 class="mb-0">Visual Side Effect Report</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-7">
                                            <div id="humanAnatomyContainer" style="height: 500px; position: relative;">
                                                <img src="/static/images/human_anatomy.jpg" 
                                                     id="anatomyImage" 
                                                     class="img-fluid" 
                                                     alt="Human Anatomy" 
                                                     style="max-height: 500px; margin: 0 auto; display: block;"
                                                     onerror="handleAnatomyImageError()">
                                                <!-- Aktif noktalar buraya dinamik olarak eklenecek -->
                                                <div id="anatomyHotspots"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="card">
                                                <div class="card-header bg-pink text-white">
                                                    <h6 class="mb-0">Body System Effects</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="bodySystems" class="list-group">
                                                        <!-- Sistem sƒ±nƒ±flarƒ± buraya dinamik olarak eklenecek -->
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card mt-3">
                                                <div class="card-header bg-pink text-white">
                                                    <h6 class="mb-0" id="selectedBodyPartTitle">Select a body part to see side effects</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="bodyPartSideEffects">
                                                        <p class="text-muted">Click on a body part or system to see possible side effects.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>

        <!-- Risk Details Modal -->
<div class="modal fade" id="riskDetailsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                <h5 class="modal-title">Detailed Risk Assessment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="riskDetailsContent">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Make sure the form submission is handled correctly
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('predictionForm');
    if (!form) return;
    
    // Setup Lab Test Add/Remove functionality
    setupLabTestControls();
    
    // Add an explicit event listener for form submission
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        // Hide any previous error messages
    document.getElementById('errorMessage').style.display = 'none';
    
        // Show loading indicator
    const resultsDiv = document.getElementById('results');
    const resultsContent = document.getElementById('resultsContent');
    
    resultsContent.innerHTML = `
        <div class="d-flex justify-content-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-3">Analyzing medications and patient data...</span>
        </div>
    `;
    resultsDiv.style.display = 'block';
    
        // Collect form data using the form's native FormData
        const formData = new FormData(form);
        
        // We don't need to manually append the medications and medical history
        // as they now have name attributes and will be included in the FormData
        
        // But we do need to handle lab tests properly
        // Remove any existing lab test entries and add them in the correct format
    const labRows = document.querySelectorAll('.lab-test-row');
        let labIndex = 0;
        
        labRows.forEach(row => {
        const testName = row.querySelector('.test-name').value;
        const testResult = row.querySelector('.test-result').value;
        const testUnit = row.querySelector('.test-unit').value;
        
        if (testName && testResult) {
                formData.append(`lab-name-${labIndex}`, testName);
                formData.append(`lab-value-${labIndex}`, testResult);
            if (testUnit) {
                    formData.append(`lab-unit-${labIndex}`, testUnit);
            }
                labIndex++;
        }
    });
    
    try {
            // Make the prediction request
        const response = await fetch('/predict', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        console.log('Prediction results:', data);
        
        if (data.status === 'error') {
            // Show error message
            document.getElementById('errorText').textContent = data.message || 'An error occurred during prediction';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            return;
        }
        
        // Format and display results
        if (data.status === 'success' && data.data && data.data.results && data.data.results.length > 0) {
            // Create results table
            let resultsHTML = '<div class="table-responsive"><table class="table table-striped">';
            resultsHTML += '<thead><tr><th>Medication</th><th>Risk Level</th><th>Probability</th><th>Recommendation</th></tr></thead>';
            resultsHTML += '<tbody>';
            
                data.data.results.forEach(result => {
                const riskLevel = result.risk_level || 'Unknown';
                const riskColorClass = riskLevel === 'Low' ? 'text-success' : 
                                      riskLevel === 'Medium' ? 'text-warning' : 'text-danger';
                
                resultsHTML += `<tr>
                    <td>${result.medication}</td>
                    <td><strong class="${riskColorClass}">${riskLevel}</strong></td>
                    <td>${Math.round(parseFloat(result.probability) * 100)}%</td>
                    <td>${result.recommendation}</td>
                </tr>`;
            });
            
            resultsHTML += '</tbody></table></div>';
            resultsContent.innerHTML = resultsHTML;
            resultsDiv.style.display = 'block';
            
                // Create charts and visualizations
            document.getElementById('visualizations').style.display = 'block';
            createCharts(data.data);
            
                // If side effects are available, create the anatomy visualization
            if (data.data.side_effects && data.data.side_effects.length > 0) {
                    // Make sure the side effects section is visible
                    document.querySelector('.row.mt-4 .card').style.display = 'block';
                    
                    // Already called in createCharts, but ensure it's done
                    console.log("Creating anatomy visualization with", data.data.side_effects.length, "side effects");
            }
        } else {
            // No results or error
            resultsContent.innerHTML = '<div class="alert alert-warning">No prediction results returned.</div>';
            resultsDiv.style.display = 'block';
            document.getElementById('visualizations').style.display = 'none';
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('errorText').textContent = error.message || 'An unexpected error occurred';
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('results').style.display = 'none';
        document.getElementById('visualizations').style.display = 'none';
    }
});
});

// Setup lab test add/remove functionality
function setupLabTestControls() {
    // Add lab test button
    const addLabTestBtn = document.getElementById('addLabTest');
    if (addLabTestBtn) {
        addLabTestBtn.addEventListener('click', function() {
            const container = document.querySelector('.lab-test-container');
            const newRow = document.querySelector('.lab-test-row').cloneNode(true);
            
            // Clear values
            newRow.querySelectorAll('input, select').forEach(input => {
                input.value = '';
            });
            
            // Setup remove button
            const removeBtn = newRow.querySelector('.remove-test');
            removeBtn.addEventListener('click', function() {
                newRow.remove();
            });
            
            container.appendChild(newRow);
        });
    }
    
    // Setup existing remove buttons
    document.querySelectorAll('.remove-test').forEach(btn => {
        btn.addEventListener('click', function() {
            // Don't remove if it's the only row
            const rows = document.querySelectorAll('.lab-test-row');
            if (rows.length > 1) {
                this.closest('.lab-test-row').remove();
            } else {
                // Clear values instead
                const inputs = this.closest('.lab-test-row').querySelectorAll('input, select');
                inputs.forEach(input => input.value = '');
            }
        });
    });
}
</script>
{% endblock %} 